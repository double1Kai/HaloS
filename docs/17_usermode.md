# 任务状态段
一个任务分成两个部分
- 执行空间
- 状态空间

任务状态段（TSS），保存了某个进程对应的所有寄存器的值，用于实现中断时用户态到内核态的过程

```c++
typedef struct tss_t{
    u32 backlink;   //前一个任务的链接，保存了前一个状态段的段选择子，即前一个任务调用了这个任务
    u32 esp0;       //ring0的栈顶地址
    u32 ss0;        //ring0的段选择子
    u32 esp1;      
    u32 ss1;       
    u32 esp2;       
    u32 ss0;
    //level3已经是最低特权级了，不用存了，12也用不到，有个0（内核态）用一用就行
    u32 cr3;
    u32 eip;
    u32 flags;
    u32 eax;
    u32 ecx;
    u32 edx;
    u32 ebx;
    u32 esp;
    u32 ebp;
    u32 esi;
    u32 edi;
    u32 es;
    u32 cs;
    u32 ss;
    u32 ds;
    u32 fs;
    u32 gs;         //硬件切换自动保存，低效，用不到
    u32 ldtr;       //局部描述符选择子，每个任务都有一个，用不太到
    u16 trace : 1;  //debug用的，任务切换时会引发一个调试异常
    u16 reserved : 15;//空闲
    u16 iobase;     //I/O位图基地址
    u32 ssp;        //任务影子栈指针，防止缓冲区溢出攻击
} _packed tss_t;
```
## 任务状态段描述符
存在全局描述符内部
加载描述符`ltr`

## 中断门处理过程
如果处理程序（gate_t）运行在低特权级，那么栈切换就会发生
- 内核特权级的栈段选择子和栈顶指针将从TSS中获取
- 并会在内核栈中压入用户态的栈段选择子和栈顶指针
- 保存当前的状态 eflags cs eip 到内核栈
- 如果存在错误码，还应该压入错误码

如果处理程序（gate_t）运行在相同特权级
- 保存当前的状态 eflags cs eip 到内核栈
- 如果存在错误码，还应该压入错误码

## 进入用户模式
用户态到内核态时会从tss中获取ss0和esp0