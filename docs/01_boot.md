# 主引导扇区boot
## BIOS（Basic Input Output System）
BIOS在加电自检后，将主引导扇区读到0x7c00的位置，并跳转到这里执行

0x10，BIOS系统调用，显示器相关的功能，将ax设置为3（传参），再调用即可清除屏幕内容

## 主引导扇区结构
- 代码：466B
- 硬盘分区表：64B
- 0x55 和 0xaa 共计512B

## 主引导扇区功能
读取内核加载器并执行，再由内核加载器读入内核(主引导扇区代码只有466B，可能不够读入内核，所以先整个加载器)  

## 硬盘读写
- 扇区：硬盘读写的最小单位，最小一个，最多256个  
- 磁道：从外侧计数，C盘一般在最外面，读写速度最快

### 读写模式
- CHS模式：Cylinder/Head/Sector
- LBA模式：Logic Block Address  
采用LBA28模式（28位地址，能访问128G的空间）

### 端口
端口相当于外部设备内部的寄存器  
- 0x1F0：16bit，用于读写数据
- 0x1F1：检测前一个指令的错误
- 0x1F2：读写扇区的数量
- 0x1F3：起始扇区低8位
- 0x1F4：起始扇区中8位
- 0x1F5：起始扇区高8位
- 0x1F6：
    - 0~3位：起始扇区最高4位
    - 4位：0->主盘，1->从盘
    - 6位：0->CHS，1->LBA
    - 5、7位：固定为1
- 0x1F7：out操作
    - 0xEC：识别硬盘
    - 0x20：读硬盘
    - 0x30: 写硬盘
- 0x1F7：in操作/8bit
    - 0位：1->ERR
    - 3位：1->DRQ 数据准备完毕
    - 7位: 1->BSY 硬盘繁忙
** 读硬盘是等硬盘空闲，再读入内存 **
** 写硬盘是先写入内存，再等硬盘空闲 **

## 实模式
### 寻址方式 
> 有效地址 = 段地址*16 + 偏移地址

段地址向左移动4位，凑出20位地址

### print
0x10系统调用的子功能0xe0
- ah: 0x0e
- al: 字符
- int 0x10

### 实模式内存布局
| 起点地址 | 绑定地址 | 大小 | 用途|
| ---------- | ---------- | ------ | ------------------ |
| `0x000` | `0x3FF` | 1KB | 中断向量表 |
| `0x400` | `0x4FF` | 256B | BIOS数据区|
| `0x500` | `0x7BFF` | 29.75 KB | 可用区域 |
| `0x7C00` | `0x7DFF` | 512B | MBR 加载区 |
| `0x7E00` | `0x9FBFF` | 607.6KB | 可用区域 |
| `0x9FC00` | `0x9FFFF` | 1KB | 扩展 BIOS 数据区 |
| `0xA0000` | `0xAFFFF` | 64KB | 用于彩色显示适配器 |
| `0xB0000` | `0xB7FFF` | 32KB | 用于黑色显示合适的配器 |
| `0xB8000` | `0xBFFFF` | 32KB | 用于文本显示合适的配器 |
| `0xC0000` | `0xC7FFF` | 32KB | 显示合适的配置器 BIOS |
| `0xC8000` | `0xEFFFF` | 160KB | 投影内存 |
| `0xF0000` | `0xFFFEF` | 64KB-16B | 系统BIOS |
| `0xFFFF0` | `0xFFFFF` | 16B | 系统BIOS入口地址|

## multiboot2 头

要支持 multiboot2，内核必须添加一个 multiboot 头，而且必须再内核开始的 32768(0x8000) 字节，而且必须 64 字节对齐；

| 偏移  | 类型 | 名称                | 备注 |
| ----- | ---- | ------------------- | ---- |
| 0     | u32  | 魔数 (magic)        | 必须 |
| 4     | u32  | 架构 (architecture) | 必须 |
| 8     | u32  | 头部长度 (header_length)   | 必须 |
| 12    | u32  | 校验和 (checksum)   | 必须 |
| 16-XX |      | 标记 (tags)         | 必须 |

- `magic` = 0xE85250D6
- `architecture`:
    - 0：32 位保护模式
- `checksum`：与 `magic`, `architecture`, `header_length` 相加必须为 `0`

## i386状态
- eax：魔数0x36d76289，太复杂了，直接抄了



